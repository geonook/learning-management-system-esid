<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>SSO Configuration Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
        h2 { color: #2196F3; margin-top: 0; }
        .result { padding: 10px; background: #f9f9f9; border-left: 4px solid #2196F3; margin: 10px 0; }
        .success { border-left-color: #4CAF50; background: #e8f5e9; }
        .error { border-left-color: #f44336; background: #ffebee; }
        .warning { border-left-color: #ff9800; background: #fff3e0; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #45a049; }
        pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; }
        code { background: #e0e0e0; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîç SSO Configuration Diagnostic Tool</h1>

    <div class="section">
        <h2>üìç Current Environment</h2>
        <div id="env-info"></div>
    </div>

    <div class="section">
        <h2>üîß Test getOAuthCallbackUrl() Function</h2>
        <div id="callback-test"></div>
    </div>

    <div class="section">
        <h2>üåê Simulate Authorization URL Construction</h2>
        <div id="auth-url-test"></div>
    </div>

    <div class="section">
        <h2>‚ö†Ô∏è Potential Issues Detected</h2>
        <div id="issues"></div>
    </div>

    <div class="section">
        <h2>üß™ Actions</h2>
        <button onclick="runDiagnostics()">üîÑ Re-run Diagnostics</button>
        <button onclick="copyReport()">üìã Copy Report to Clipboard</button>
        <button onclick="window.location.href='/auth/login'">‚Üê Back to Login</button>
    </div>

    <script>
        // Simulate getOAuthCallbackUrl() from lib/config/sso.ts
        function getOAuthCallbackUrl() {
            if (typeof window !== 'undefined') {
                return `${window.location.origin}/api/auth/callback/infohub`
            }
            return 'http://localhost:3000/api/auth/callback/infohub'
        }

        // Simulate getPublicSSOConfig()
        function getPublicSSOConfig() {
            // These should match the actual environment variables
            return {
                clientId: 'eb88b24e-8392-45c4-b7f7-39f03b6df208',
                authUrl: 'https://next14-landing.zeabur.app/api/oauth/authorize',
                enableSSO: true
            }
        }

        function runDiagnostics() {
            const issues = []
            let report = '=== SSO DIAGNOSTIC REPORT ===\n\n'

            // 1. Environment Info
            const envInfo = {
                'Current URL': window.location.href,
                'Origin': window.location.origin,
                'Protocol': window.location.protocol,
                'Host': window.location.host,
                'Pathname': window.location.pathname,
            }

            let envHtml = '<div class="result">'
            report += '1. ENVIRONMENT INFO:\n'
            for (const [key, value] of Object.entries(envInfo)) {
                envHtml += `<strong>${key}:</strong> ${value}<br>`
                report += `   ${key}: ${value}\n`
            }
            envHtml += '</div>'
            document.getElementById('env-info').innerHTML = envHtml

            // 2. Test getOAuthCallbackUrl()
            const callbackUri = getOAuthCallbackUrl()
            const expectedCallbackUri = 'https://lms-staging.zeabur.app/api/auth/callback/infohub'

            let callbackHtml = '<div class="result '
            if (callbackUri === expectedCallbackUri) {
                callbackHtml += 'success">‚úÖ CORRECT'
                report += '\n2. CALLBACK URI: ‚úÖ CORRECT\n'
            } else if (callbackUri.includes('localhost')) {
                callbackHtml += 'error">‚ùå ERROR: Using localhost'
                issues.push('Callback URI is using localhost instead of staging domain')
                report += '\n2. CALLBACK URI: ‚ùå ERROR\n'
            } else {
                callbackHtml += 'warning">‚ö†Ô∏è WARNING: Unexpected value'
                issues.push('Callback URI has unexpected value')
                report += '\n2. CALLBACK URI: ‚ö†Ô∏è WARNING\n'
            }
            callbackHtml += `</div>
                <div class="result">
                    <strong>Computed:</strong> ${callbackUri}<br>
                    <strong>Expected:</strong> ${expectedCallbackUri}<br>
                    <strong>Match:</strong> ${callbackUri === expectedCallbackUri ? '‚úÖ Yes' : '‚ùå No'}
                </div>`

            report += `   Computed: ${callbackUri}\n`
            report += `   Expected: ${expectedCallbackUri}\n`
            report += `   Match: ${callbackUri === expectedCallbackUri}\n`

            document.getElementById('callback-test').innerHTML = callbackHtml

            // 3. Test Authorization URL Construction
            const config = getPublicSSOConfig()
            const testState = 'test_state_123'
            const testChallenge = 'test_challenge_abc'

            const authParams = new URLSearchParams({
                client_id: config.clientId,
                redirect_uri: callbackUri,
                response_type: 'code',
                code_challenge: testChallenge,
                code_challenge_method: 'S256',
                state: testState,
                scope: 'openid profile email'
            })

            const authUrl = `${config.authUrl}?${authParams.toString()}`

            let authUrlHtml = '<div class="result">'
            authUrlHtml += `<strong>Authorization URL:</strong><br><code style="display:block;word-break:break-all;margin-top:5px;">${authUrl}</code>`
            authUrlHtml += '</div><div class="result"><strong>Parameters:</strong><br>'

            report += '\n3. AUTHORIZATION URL:\n'
            report += `   URL: ${authUrl}\n\n`
            report += '   Parameters:\n'

            authParams.forEach((value, key) => {
                authUrlHtml += `<strong>${key}:</strong> ${value}<br>`
                report += `   ${key}: ${value}\n`
            })
            authUrlHtml += '</div>'
            document.getElementById('auth-url-test').innerHTML = authUrlHtml

            // 4. Check for issues
            let issuesHtml = ''
            report += '\n4. ISSUES DETECTED:\n'

            if (window.location.origin.includes('localhost')) {
                issues.push('‚ùå You are accessing from localhost - this will cause redirect_uri issues')
                report += '   ‚ùå Accessing from localhost\n'
            }

            if (callbackUri.includes('localhost')) {
                issues.push('‚ùå Callback URI contains localhost - this WILL fail')
                report += '   ‚ùå Callback URI contains localhost\n'
            }

            if (!config.authUrl.includes('next14-landing.zeabur.app')) {
                issues.push('‚ö†Ô∏è Info Hub URL looks incorrect')
                report += '   ‚ö†Ô∏è Info Hub URL incorrect\n'
            }

            if (issues.length === 0) {
                issuesHtml = '<div class="result success">‚úÖ No issues detected! Configuration looks correct.</div>'
                report += '   ‚úÖ No issues detected\n'
            } else {
                issues.forEach(issue => {
                    issuesHtml += `<div class="result error">${issue}</div>`
                })
            }
            document.getElementById('issues').innerHTML = issuesHtml

            // Store report for copying
            window.diagnosticReport = report
        }

        function copyReport() {
            if (window.diagnosticReport) {
                navigator.clipboard.writeText(window.diagnosticReport).then(() => {
                    alert('‚úÖ Diagnostic report copied to clipboard!')
                }).catch(err => {
                    console.error('Copy failed:', err)
                    prompt('Please copy manually:', window.diagnosticReport)
                })
            }
        }

        // Run diagnostics on page load
        runDiagnostics()
    </script>
</body>
</html>
