<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SSO Flow Test - LMS Staging</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #4CAF50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.warning { background: #ff9800; color: white; }
        .param {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .key {
            color: #1976D2;
            font-weight: bold;
        }
        .value {
            color: #388E3C;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success-box {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        code {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” SSO Flow Test - LMS Staging Environment</h1>

        <div class="success-box">
            âœ… <strong>éƒ¨ç½²æˆåŠŸï¼</strong>æ­£åœ¨é©—è­‰ OAuth åƒæ•¸...
        </div>

        <div class="section">
            <h2>ğŸ“ ç•¶å‰ç’°å¢ƒ</h2>
            <div class="param">
                <span class="key">Current Origin:</span>
                <span class="value" id="current-origin"></span>
            </div>
            <div class="param">
                <span class="key">Current URL:</span>
                <span class="value" id="current-url"></span>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”§ è¨ˆç®—çš„ redirect_uri</h2>
            <div class="param">
                <span class="key">redirect_uri:</span>
                <span class="value" id="redirect-uri"></span>
                <span id="redirect-status"></span>
            </div>
            <div class="param">
                <span class="key">è¨ˆç®—æ–¹å¼:</span>
                <span class="value">window.location.origin + '/api/auth/callback/infohub'</span>
            </div>
        </div>

        <div class="section">
            <h2>ğŸŒ å®Œæ•´æˆæ¬Š URL</h2>
            <div id="auth-url-display" style="word-break: break-all; margin: 10px 0;"></div>
            <button onclick="copyAuthUrl()">ğŸ“‹ è¤‡è£½æˆæ¬Š URL</button>
        </div>

        <div class="section">
            <h2>ğŸ“Š URL åƒæ•¸è©³ç´°è§£æ</h2>
            <div id="params-display"></div>
        </div>

        <div class="warning-box" id="test-info">
            <strong>âš ï¸ æ¸¬è©¦èªªæ˜ï¼š</strong>
            <ul>
                <li>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡é–‹å•Ÿç€è¦½å™¨ DevTools</li>
                <li>åˆ‡æ›åˆ° <strong>Network</strong> æ¨™ç±¤</li>
                <li>è§€å¯Ÿå®Œæ•´çš„é‡å®šå‘æµç¨‹</li>
                <li>æª¢æŸ¥æ˜¯å¦æ­£ç¢ºé‡å®šå‘å› LMSï¼ˆè€Œé localhost:8080ï¼‰</li>
            </ul>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="testSSOLogin()" style="font-size: 18px; padding: 20px 40px;">
                ğŸš€ é–‹å§‹æ¸¬è©¦ SSO ç™»å…¥
            </button>
            <button class="secondary" onclick="openDevTools()">
                ğŸ” é–‹å•Ÿ DevTools
            </button>
        </div>

        <div class="section">
            <h2>âœ… é æœŸè¡Œç‚º vs âŒ ä¹‹å‰çš„éŒ¯èª¤</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background: #4CAF50; color: white;">
                    <th style="padding: 10px; border: 1px solid #ddd;">æ­¥é©Ÿ</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">âœ… é æœŸï¼ˆæ­£ç¢ºï¼‰</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">âŒ ä¹‹å‰ï¼ˆéŒ¯èª¤ï¼‰</th>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>1. æˆæ¬Šè«‹æ±‚</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: #d4edda;">
                        redirect_uri=<code>https://lms-staging.zeabur.app/api/auth/callback/infohub</code>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: #f8d7da;">
                        redirect_uri=<code>http://localhost:3000/...</code>
                    </td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>2. Google ç™»å…¥</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: #d4edda;">
                        æˆåŠŸç™»å…¥ Google
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: #d4edda;">
                        æˆåŠŸç™»å…¥ Google âœ…
                    </td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>3. Info Hub é‡å®šå‘</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: #d4edda;">
                        é‡å®šå‘åˆ° <code>https://lms-staging.zeabur.app/api/auth/callback/infohub?code=...</code>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: #f8d7da;">
                        é‡å®šå‘åˆ° <code>https://localhost:8080/dashboard</code> âŒ
                    </td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>4. æœ€çµ‚çµæœ</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: #d4edda;">
                        æˆåŠŸç™»å…¥ LMS Dashboard
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: #f8d7da;">
                        ERR_CONNECTION_REFUSED âŒ
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬ getOAuthCallbackUrl() å‡½å¼
        function getOAuthCallbackUrl() {
            if (typeof window !== 'undefined') {
                return `${window.location.origin}/api/auth/callback/infohub`
            }
            return 'http://localhost:3000/api/auth/callback/infohub'
        }

        // åˆå§‹åŒ–é¡¯ç¤º
        const currentOrigin = window.location.origin
        const currentUrl = window.location.href
        const redirectUri = getOAuthCallbackUrl()

        document.getElementById('current-origin').textContent = currentOrigin
        document.getElementById('current-url').textContent = currentUrl
        document.getElementById('redirect-uri').textContent = redirectUri

        // æª¢æŸ¥ redirect_uri æ˜¯å¦æ­£ç¢º
        const redirectStatus = document.getElementById('redirect-status')
        if (redirectUri.includes('lms-staging.zeabur.app')) {
            redirectStatus.innerHTML = '<span class="status success">âœ… æ­£ç¢º</span>'
        } else if (redirectUri.includes('localhost')) {
            redirectStatus.innerHTML = '<span class="status error">âŒ éŒ¯èª¤ï¼ˆä½¿ç”¨ localhostï¼‰</span>'
        } else {
            redirectStatus.innerHTML = '<span class="status warning">âš ï¸ æœªçŸ¥ç’°å¢ƒ</span>'
        }

        // å»ºæ§‹æˆæ¬Š URLï¼ˆä½¿ç”¨çœŸå¯¦çš„ staging é…ç½®ï¼‰
        const config = {
            clientId: 'eb88b24e-8392-45c4-b7f7-39f03b6df208',
            authUrl: 'https://next14-landing.zeabur.app/api/oauth/authorize'
        }

        // ç”Ÿæˆç°¡å–®çš„æ¸¬è©¦ç”¨ PKCE challengeï¼ˆå¯¦éš›æ‡‰ç”¨æœƒä½¿ç”¨ SHA-256ï¼‰
        const testCodeChallenge = btoa('test_code_verifier_for_debugging_only').replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_')
        const testState = 'test_state_' + Math.random().toString(36).substring(7)

        const authParams = new URLSearchParams({
            client_id: config.clientId,
            redirect_uri: redirectUri,
            response_type: 'code',
            code_challenge: testCodeChallenge,
            code_challenge_method: 'S256',
            state: testState,
            scope: 'openid profile email',
        })

        const authUrl = `${config.authUrl}?${authParams.toString()}`

        // é¡¯ç¤ºæˆæ¬Š URL
        document.getElementById('auth-url-display').innerHTML =
            `<code style="display: block; padding: 15px; background: #e0e0e0; border-radius: 5px; overflow-x: auto;">${authUrl}</code>`

        // é¡¯ç¤ºåƒæ•¸
        let paramsHtml = ''
        authParams.forEach((value, key) => {
            let displayValue = value
            if (key === 'code_challenge' && value.length > 50) {
                displayValue = value.substring(0, 50) + '...'
            }
            paramsHtml += `
                <div class="param">
                    <span class="key">${key}:</span>
                    <span class="value">${displayValue}</span>
                </div>
            `
        })
        document.getElementById('params-display').innerHTML = paramsHtml

        // è¤‡è£½æˆæ¬Š URL
        function copyAuthUrl() {
            navigator.clipboard.writeText(authUrl).then(() => {
                alert('âœ… æˆæ¬Š URL å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼')
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err)
                prompt('è«‹æ‰‹å‹•è¤‡è£½æ­¤ URL:', authUrl)
            })
        }

        // é–‹å•Ÿ DevTools
        function openDevTools() {
            alert('è«‹æŒ‰ F12 æˆ– Cmd+Option+I (Mac) é–‹å•Ÿ DevToolsï¼Œç„¶å¾Œåˆ‡æ›åˆ° Network æ¨™ç±¤')
        }

        // æ¸¬è©¦ SSO ç™»å…¥
        function testSSOLogin() {
            if (confirm(
                'å³å°‡é–‹å§‹ SSO ç™»å…¥æ¸¬è©¦\n\n' +
                'âœ… redirect_uri: ' + redirectUri + '\n\n' +
                'è«‹ç¢ºèªï¼š\n' +
                '1. DevTools å·²é–‹å•Ÿä¸¦åˆ‡æ›åˆ° Network æ¨™ç±¤\n' +
                '2. æº–å‚™è§€å¯Ÿå®Œæ•´çš„é‡å®šå‘æµç¨‹\n' +
                '3. æª¢æŸ¥æœ€çµ‚æ˜¯å¦é‡å®šå‘åˆ° LMSï¼ˆè€Œé localhost:8080ï¼‰\n\n' +
                'ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ'
            )) {
                console.log('[SSO Test] Starting SSO login flow...')
                console.log('[SSO Test] redirect_uri:', redirectUri)
                console.log('[SSO Test] Full auth URL:', authUrl)

                // å¯¦éš›é‡å®šå‘
                window.location.href = authUrl
            }
        }

        // è‡ªå‹•åŸ·è¡Œæª¢æŸ¥
        console.log('=== SSO Configuration Check ===')
        console.log('Current Origin:', currentOrigin)
        console.log('redirect_uri:', redirectUri)
        console.log('Is Correct?', redirectUri.includes('lms-staging.zeabur.app'))
        console.log('Full Auth URL:', authUrl)
    </script>
</body>
</html>
