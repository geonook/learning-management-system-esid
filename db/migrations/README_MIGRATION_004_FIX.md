# Migration 004 Fix: è™•ç†ç¾å­˜è³‡æ–™ç´„æŸè¡çª

## ğŸš¨ å•é¡ŒèƒŒæ™¯
åŸå§‹çš„ Migration 004 åŸ·è¡Œå¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯ï¼š
```
ERROR: 23514: check constraint "users_grade_check" of relation "users" is violated by some row
```

**åŸå› **ï¼šè³‡æ–™åº«ä¸­å·²å­˜åœ¨ grade å€¼åœ¨ 7-12 ç¯„åœçš„è³‡æ–™ï¼ˆä¸­å­¸åˆ¶ï¼‰ï¼Œç„¡æ³•ç›´æ¥æ‡‰ç”¨ 1-6 çš„æ–°ç´„æŸï¼ˆå°å­¸åˆ¶ï¼‰ã€‚

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### å…©éšæ®µä¿®å¾©æµç¨‹

#### éšæ®µ 1ï¼šæª¢æŸ¥ç¾å­˜è³‡æ–™
**æª”æ¡ˆ**ï¼š`004a_check_existing_data.sql`

**ç›®çš„**ï¼š
- åˆ†æ users, classes, students, assessment_titles è¡¨ä¸­çš„ç¾å­˜è³‡æ–™
- è­˜åˆ¥é•åæ–°ç´„æŸçš„è¨˜éŒ„
- æä¾›è³‡æ–™è™•ç†å»ºè­°

**åŸ·è¡Œæ–¹å¼**ï¼š
```sql
-- åœ¨ Supabase SQL Editor ä¸­è¤‡è£½è²¼ä¸ŠåŸ·è¡Œ
-- æª¢æŸ¥çµæœï¼Œäº†è§£è¡çªè³‡æ–™çš„æ•¸é‡å’Œå…§å®¹
```

#### éšæ®µ 2ï¼šå®‰å…¨é·ç§»
**æª”æ¡ˆ**ï¼š`004b_migrate_grade_constraints_safely.sql`

**ç›®çš„**ï¼š
- å®‰å…¨æ¸…ç†é•åç´„æŸçš„è³‡æ–™
- é€æ­¥æ›´æ–°æ¯å€‹è¡¨çš„ç´„æŸæ¢ä»¶
- é©—è­‰æ–°ç´„æŸæ­£ç¢ºæ‡‰ç”¨

**è³‡æ–™è™•ç†ç­–ç•¥**ï¼š
- **users è¡¨**ï¼šå°‡é•åç´„æŸçš„ grade è¨­ç‚º NULL
- **classes è¡¨**ï¼šåˆªé™¤ä¸­å­¸åˆ¶ç­ç´šåŠç›¸é—œè³‡æ–™ï¼ˆæŒ‰å¤–éµä¾è³´é †åºï¼‰
- **students è¡¨**ï¼šåˆªé™¤ä¸­å­¸åˆ¶å­¸ç”ŸåŠç›¸é—œè³‡æ–™  
- **assessment_titles è¡¨**ï¼šå°‡é•åç´„æŸçš„ grade è¨­ç‚º NULL

**âš ï¸ å¤–éµä¾è³´è™•ç†é †åº**ï¼š
1. assessment_titles (å¼•ç”¨ classes.id)
2. scores (å¼•ç”¨ students.id)
3. student_courses (å¼•ç”¨ students.id å’Œ courses.id)
4. courses (å¼•ç”¨ classes.id)
5. students (å¼•ç”¨ classes.id)
6. classes (ä¸»è¡¨)

## ğŸ“‹ åŸ·è¡Œæ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæª¢æŸ¥è³‡æ–™ç‹€æ³
1. é–‹å•Ÿ `004a_check_existing_data.sql`
2. è¤‡è£½å…¨éƒ¨å…§å®¹åˆ° Supabase SQL Editor
3. åŸ·è¡Œä¸¦æª¢æŸ¥çµæœ
4. ç¢ºèªè¡çªè³‡æ–™çš„æ•¸é‡å’Œé¡å‹

### æ­¥é©Ÿ 2ï¼šåŸ·è¡Œå®‰å…¨é·ç§»
1. é–‹å•Ÿ `004b_migrate_grade_constraints_safely.sql`
2. è¤‡è£½å…¨éƒ¨å…§å®¹åˆ° Supabase SQL Editor
3. åŸ·è¡Œé·ç§»ï¼ˆæœƒè‡ªå‹•æ¸…ç†è¡çªè³‡æ–™ï¼‰
4. æª¢æŸ¥åŸ·è¡Œçµæœç¢ºèªæˆåŠŸ

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### è³‡æ–™æ¸…ç†å½±éŸ¿
- **users è¡¨**ï¼šä¸­å­¸åˆ¶æ•™å¸«/ç®¡ç†å“¡çš„ grade æœƒè¢«è¨­ç‚º NULL
- **classes è¡¨**ï¼šæ‰€æœ‰ä¸­å­¸åˆ¶ç­ç´šæœƒè¢«åˆªé™¤
- **students è¡¨**ï¼šæ‰€æœ‰ä¸­å­¸åˆ¶å­¸ç”Ÿæœƒè¢«åˆªé™¤
- **ç›¸é—œè³‡æ–™**ï¼šèª²ç¨‹ã€è¨»å†Šè¨˜éŒ„ã€æˆç¸¾ç­‰ç›¸é—œè³‡æ–™ä¹Ÿæœƒè¢«æ¸…ç†

### å®‰å…¨è€ƒé‡
- âœ… é·ç§»è…³æœ¬åŒ…å«è©³ç´°çš„æ—¥èªŒè¼¸å‡º
- âœ… æ¯æ­¥é©Ÿéƒ½æœ‰åŸ·è¡Œç‹€æ…‹ç¢ºèª
- âœ… åŒ…å«ç´„æŸé©—è­‰æ¸¬è©¦
- âš ï¸ **ä¸å¯é€†æ“ä½œ**ï¼šæ¸…ç†çš„è³‡æ–™ç„¡æ³•æ¢å¾©

### é©ç”¨å ´æ™¯
- æ¸¬è©¦ç’°å¢ƒï¼šå®‰å…¨åŸ·è¡Œï¼Œæ¸…ç†æ¸¬è©¦è³‡æ–™
- ç”Ÿç”¢ç’°å¢ƒï¼šéœ€è¦å…ˆå‚™ä»½ï¼Œç¢ºèªè³‡æ–™æ¸…ç†ç­–ç•¥

## âœ… é æœŸåŸ·è¡Œçµæœ

### éšæ®µ 1 è¼¸å‡ºç¯„ä¾‹
```
TOTAL CONFLICTS: X records
Recommendation: CONFLICTS FOUND - Need to clean/convert data before applying constraints
```

### éšæ®µ 2 è¼¸å‡ºç¯„ä¾‹
```
Found X conflicting records in users table
Updated X users records: set conflicting grades to NULL
...
SUCCESS: Primary school grade 3 accepted
SUCCESS: Middle school grade 8 correctly rejected
Database now supports only primary school grades 1-6 (G1-G6)
```

## ğŸ¯ å®Œæˆå¾Œç‹€æ…‹

åŸ·è¡ŒæˆåŠŸå¾Œï¼š
- âœ… è³‡æ–™åº«åªæ”¯æ´å°å­¸åˆ¶ grade 1-6
- âœ… æ‰€æœ‰ç´„æŸæ¢ä»¶æ­£ç¢ºæ‡‰ç”¨
- âœ… æ¸¬è©¦ CSV è³‡æ–™å¯ä»¥æ­£å¸¸å°å…¥
- âœ… è§¸ç™¼å™¨æ¸¬è©¦å¯ä»¥ä½¿ç”¨çœŸå¯¦å°å­¸å¹´ç´š

## ğŸš€ å¾ŒçºŒæ­¥é©Ÿ

1. **é©—è­‰ç´„æŸ**ï¼šç¢ºèªæ–°ç´„æŸæ­£ç¢ºæ‡‰ç”¨
2. **æ¸¬è©¦å°å…¥**ï¼šä½¿ç”¨ `/test-data-courses/` æ¸¬è©¦è³‡æ–™
3. **åŠŸèƒ½æ¸¬è©¦**ï¼šé©—è­‰å®Œæ•´çš„å°å­¸èª²ç¨‹ç³»çµ±